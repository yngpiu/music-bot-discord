generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model GuildConfig {
  guildId   String   @id
  prefix    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserConfig {
  userId    String   @id
  prefix    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Track {
  id              String  @id // "deezer:123456789" or "youtube:dQw4w9WgXcQ"
  sourceName      String // "deezer", "youtube", "soundcloud"...
  identifier      String // Platform-specific ID
  isrc            String? // ISRC code (nullable, used for cross-source matching)
  title           String
  artist          String
  normalizedTitle String // Lowercased, cleaned title for fuzzy matching
  normalizedArtist String // Lowercased, cleaned artist for fuzzy matching
  artworkUrl      String?
  uri             String? // Full URL to the track on the source platform

  plays PlayHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isrc])
  @@index([normalizedTitle, normalizedArtist])
}

model PlayHistory {
  id        String         @id @default(cuid())
  trackId   String
  track     Track          @relation(fields: [trackId], references: [id])
  guildId   String
  botId     String
  playedAt  DateTime       @default(now())
  listeners PlayListener[]

  @@index([guildId])
  @@index([trackId])
  @@index([playedAt])
}

model PlayListener {
  id        String      @id @default(cuid())
  historyId String
  history   PlayHistory @relation(fields: [historyId], references: [id], onDelete: Cascade)
  userId    String

  @@unique([historyId, userId])
  @@index([userId])
  @@index([historyId])
}

model FavoriteTrack {
  id         String   @id @default(cuid())
  userId     String
  title      String
  author     String
  uri        String?
  identifier String
  sourceName String
  artworkUrl String?
  duration   Int      @default(0)
  isrc       String?
  addedAt    DateTime @default(now())

  @@unique([userId, identifier, sourceName])
  @@index([userId])
}
